---
const navLinks = [
	{ href: '/news', label: 'News' },
	{ href: '/reviews', label: 'Reviews' },
	{ href: '/music-appreciation', label: 'Music Appreciation' },
	{ href: '/bossfeatures', label: 'Boss Features' },
	{ href: '/imexcited', label: "I'm Excited" },
	{ href: '/search', label: 'Search' },
	{ href: '/about', label: 'About' },
];

const currentPath = Astro.url.pathname.replace(/\/+$/, '') || '/';
const isActiveLink = (href: string) => {
	const normalizedHref = href.replace(/\/+$/, '') || '/';
	if (normalizedHref === '/') return currentPath === '/';
	return currentPath === normalizedHref || currentPath.startsWith(`${normalizedHref}/`);
};
---

<header class="site-header" data-mobile-nav-root>
	<div class="header-main">
		<a class="logo" href="/">KAT</a>

		<div class="header-center">
			<a class="brand" href="/">A Kat's Kronicles</a>

			<nav class="nav" aria-label="Main navigation">
				<div class="nav-inner">
					{
						navLinks.map((link) => (
							<a href={link.href} class:list={{ 'is-active': isActiveLink(link.href) }}>
								{link.label}
							</a>
						))
					}
				</div>
			</nav>
		</div>

		<div class="header-actions">
			<a class="mobile-search-link" href="/search" aria-label="Open search">
				<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
					<circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"></circle>
					<path d="M20 20L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
				</svg>
			</a>

			<div class="header-search">
				<form role="search" action="/search/" method="get">
					<div class="search-field">
						<span class="search-icon" aria-hidden="true">
							<svg viewBox="0 0 24 24" fill="none">
								<circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"></circle>
								<path d="M20 20L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
							</svg>
						</span>
						<input type="text" name="q" placeholder="Search" aria-label="Search Game Reviews" />
					</div>
				</form>
			</div>

			<button
				type="button"
				class="mobile-nav-toggle"
				aria-expanded="false"
				aria-controls="mobile-nav-panel"
				aria-label="Open navigation menu"
				data-mobile-nav-toggle
			>
				<span></span>
				<span></span>
				<span></span>
			</button>
		</div>
	</div>

	<nav
		id="mobile-nav-panel"
		class="mobile-nav-panel"
		aria-label="Mobile navigation"
		hidden
		data-mobile-nav-panel
	>
		<div class="mobile-nav-links" role="list">
			{
				navLinks.map((link) => (
					<a href={link.href} class:list={['mobile-nav-link', { 'is-active': isActiveLink(link.href) }]} role="listitem">
						<span>{link.label}</span>
						<span class="mobile-nav-link-arrow" aria-hidden="true">&rsaquo;</span>
					</a>
				))
			}
		</div>
	</nav>
</header>

<script is:inline>
	(() => {
		const root = document.querySelector('[data-mobile-nav-root]');
		if (!root) return;

		const toggle = root.querySelector('[data-mobile-nav-toggle]');
		const panel = root.querySelector('[data-mobile-nav-panel]');
		const mobileLinks = Array.from(root.querySelectorAll('.mobile-nav-link'));
		if (!(toggle instanceof HTMLButtonElement) || !(panel instanceof HTMLElement)) return;

		const setOpen = (open) => {
			toggle.setAttribute('aria-expanded', String(open));
			root.classList.toggle('mobile-nav-open', open);
			panel.hidden = !open;
		};

		toggle.addEventListener('click', () => {
			setOpen(toggle.getAttribute('aria-expanded') !== 'true');
		});

		mobileLinks.forEach((link) => {
			link.addEventListener('click', () => setOpen(false));
		});

		document.addEventListener('click', (event) => {
			if (toggle.getAttribute('aria-expanded') !== 'true') return;
			if (!(event.target instanceof Node)) return;
			if (!root.contains(event.target)) setOpen(false);
		});

		document.addEventListener('keydown', (event) => {
			if (toggle.getAttribute('aria-expanded') !== 'true') return;
			if (event.key === 'Escape') {
				setOpen(false);
				toggle.focus();
			}
		});
	})();
</script>
