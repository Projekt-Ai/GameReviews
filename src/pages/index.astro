---
import { Image } from 'astro:assets';
import BaseLayout from '../layouts/BaseLayout.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';
import fallbackImage from '../assets/blog-placeholder-1.jpg';
import homeStylesHref from '../styles/pages/home.css?url';
import { currentlyPlaying } from '../data/currently-playing';
import { getVisibleBossFeatures } from '../utils/boss-features';
import { contentVisibilityOptions } from '../utils/content';
import { getVisibleReviews } from '../utils/reviews';

const visibility = contentVisibilityOptions(import.meta.env.DEV);
const allReviews = await getVisibleReviews(visibility);
const allBossFeatures = await getVisibleBossFeatures(visibility);

const gotyEntries = allReviews
	.filter((post) => post.data.gotyYear !== undefined)
	.sort((a, b) => (a.data.gotyYear ?? 0) - (b.data.gotyYear ?? 0));

const recentItems = [...allReviews]
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
	.slice(0, 4);

const pinnedEntry = gotyEntries.find((post) => post.data.gotyYear === 2025);
const slideshowEntries = gotyEntries.filter((post) => post.data.gotyYear !== 2025);
const defaultIndex = Math.max(
	0,
	slideshowEntries.findIndex((post) => post.data.gotyYear === 2024),
);
const featuredBossFeature =
	allBossFeatures.find((post) => post.id === 'louis-metaphor-refantazio') ??
	[...allBossFeatures].sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())[0];

const formatDate = (date: Date) =>
	date.toLocaleDateString('en-US', {
		year: 'numeric',
		month: 'short',
		day: 'numeric',
	});

const formatGenreLine = (genres: string[] = [], release = '') => {
	const parts = [];
	if (genres.length > 0) parts.push(genres.join(' / '));
	if (release) parts.push(release);
	return parts.join(' | ');
};

---

<BaseLayout
	title={SITE_TITLE}
	description={SITE_DESCRIPTION}
	variantFonts={true}
	stylesheets={[homeStylesHref]}
	scripts={[{ src: '/js/home-goty-slider.js' }]}
	mainClass="home-main"
>
			<section class="goty-spotlight">
				<p class="goty-eyebrow">Game of the Year &middot; My Picks</p>

				<div class="goty-layout">
					<div class="goty-carousel-wrap">
						<div class="goty-slider-wrap" data-goty-slider-wrap data-default-index={defaultIndex}>
							<div class="goty-slider" data-goty-slider aria-label="Game of the Year slideshow">
								{
									slideshowEntries.map((post) => (
										<div class="goty-slide">
											<article class={`featured article goty year-${post.data.gotyYear}`}>
												<div class="article-background">
													<Image
														src={post.data.heroImage ?? fallbackImage}
														alt={`${post.data.title} artwork`}
														width={1200}
														height={675}
														loading={post.data.gotyYear === 2024 ? 'eager' : 'lazy'}
														fetchpriority={post.data.gotyYear === 2024 ? 'high' : 'auto'}
													/>
												</div>
												<div class="article-overlay"></div>

												<div class={`ribbon year-${post.data.gotyYear}`}>
													<span class="ribbon-text">{post.data.gotyYear}</span>
												</div>

												<div class="article-content">
													<p class="article-label">My Game of the Year {post.data.gotyYear}</p>
													<h2 class="article-title">{post.data.title}</h2>

													<p class="article-meta">
														{(post.data.platforms ?? []).map((platform, i, arr) => (
															<>
																<span class={platform.played ? 'my-platform' : undefined}>
																	{platform.name}
																</span>
																{i < arr.length - 1 && <span class="platform-separator"> / </span>}
															</>
														))}
													</p>

													<p class="article-meta">
														{formatGenreLine(post.data.genres ?? [], post.data.release ?? '')}
													</p>
													<p class="article-blurb">{post.data.blurb ?? ''}</p>
													<a href={`/reviews/${post.id}`} class="read-more">Read More</a>
												</div>

												<p class="image-credit">{post.data.imageCredit ?? ''}</p>
											</article>
										</div>
									))
								}
							</div>
						</div>

						<div class="goty-controls">
							<div class="goty-dots">
								{
									slideshowEntries.map((post, i) => (
										<button
											type="button"
											class={`goty-dot ${i === defaultIndex ? 'is-active' : ''}`}
											data-goty-dot
											data-goty-index={i}
											aria-label={`Go to ${post.data.title}`}
										/>
									))
								}
							</div>
							<div class="goty-arrow-group">
								<button type="button" class="goty-arrow" data-goty-prev aria-label="Previous slide">
									&lsaquo;
								</button>
								<button type="button" class="goty-arrow" data-goty-next aria-label="Next slide">
									&rsaquo;
								</button>
							</div>
						</div>
					</div>

					{
						pinnedEntry && (
							<div class="goty-pin" aria-label="Pinned Game of the Year">
								<article class={`featured article goty year-${pinnedEntry.data.gotyYear}`}>
									<div class="article-background">
										<Image
											src={pinnedEntry.data.heroImage ?? fallbackImage}
											alt={`${pinnedEntry.data.title} artwork`}
											width={1200}
											height={675}
											loading="eager"
											fetchpriority="high"
										/>
									</div>
									<div class="article-overlay"></div>

									<div class={`ribbon year-${pinnedEntry.data.gotyYear}`}>
										<span class="ribbon-text">{pinnedEntry.data.gotyYear}</span>
									</div>

									<div class="article-content">
										<p class="article-label">My Game of the Year {pinnedEntry.data.gotyYear}</p>
										<h2 class="article-title">{pinnedEntry.data.title}</h2>

										<p class="article-meta">
											{(pinnedEntry.data.platforms ?? []).map((platform, i, arr) => (
												<>
													<span class={platform.played ? 'my-platform' : undefined}>
														{platform.name}
													</span>
													{i < arr.length - 1 && <span class="platform-separator"> / </span>}
												</>
											))}
										</p>

										<p class="article-meta">
											{formatGenreLine(pinnedEntry.data.genres ?? [], pinnedEntry.data.release ?? '')}
										</p>
										<p class="article-blurb">{pinnedEntry.data.blurb ?? ''}</p>
										<a href={`/reviews/${pinnedEntry.id}`} class="read-more">Read More</a>
									</div>

									<p class="image-credit">{pinnedEntry.data.imageCredit ?? ''}</p>
								</article>
							</div>
						)
					}
				</div>
			</section>

			<div class="feature-and-recents-separator">
				<div class="feature-recents-stack">
					<section class="boss-feature">
						<p class="section-eyebrow">Boss Feature</p>
						<div class="boss-panel">
							<div class="boss-image-shell">
								<div class="boss-image">
									<Image
										src={featuredBossFeature?.data.heroImage ?? fallbackImage}
										alt={featuredBossFeature ? `${featuredBossFeature.data.title} boss feature` : 'Boss Feature Thumbnail'}
										width={1100}
										height={619}
										loading="eager"
										fetchpriority="high"
									/>
								</div>
							</div>
							<div class="boss-content">
								<span class="boss-tag">Featured Essay</span>
								<h2 class="boss-title">
									{featuredBossFeature?.data.title ?? 'Boss Feature Title'}
								</h2>
								<p class="boss-excerpt">
									{featuredBossFeature?.data.blurb ??
										featuredBossFeature?.data.description ??
										'This is a special boss feature highlighting an important topic or review in depth.'}
								</p>
								<a
									href={featuredBossFeature ? `/bossfeatures/${featuredBossFeature.id}/` : '/bossfeatures/'}
									class="boss-cta"
								>
									Read More &rarr;
								</a>
							</div>
						</div>
					</section>

					<section class="recent-articles">
						<div class="section-header">
							<h2 class="section-title">Recent</h2>
							<a href="/reviews" class="section-link">View All &rarr;</a>
						</div>

						<div class="recents-list">
							{
								recentItems.map((post, index) => (
									<a href={`/reviews/${post.id}/`} class={`recent-item recent-item-${index + 1}`}>
										<div class="recent-thumb">
											<Image
												src={post.data.heroImage ?? fallbackImage}
												alt={post.data.title}
												width={560}
												height={315}
											/>
										</div>
										<div class="recent-content">
											<div class="recent-time">
												<time datetime={post.data.pubDate.toISOString()}>
													{formatDate(post.data.pubDate)}
												</time>
											</div>
											<h3 class="recent-title">{post.data.title}</h3>
											<p class="recent-excerpt">{post.data.description}</p>
										</div>
									</a>
								))
							}
						</div>
					</section>
				</div>

				<aside class="currently-playing" aria-label="Currently playing">
					<div class="currently-header">
						<h2>Currently Playing</h2>
						<span class="pulse" aria-hidden="true"></span>
					</div>

					<div class="currently-list">
						{
							currentlyPlaying.map((game) => (
								<article class="playing-card">
									<div class="playing-meta">
										{game.platform && <span class="playing-platform">{game.platform}</span>}
										{game.status && <span class="playing-status">{game.status}</span>}
									</div>
									<h3 class="playing-title">{game.title}</h3>
									{game.note && <p class="playing-note">{game.note}</p>}
								</article>
							))
						}
					</div>
				</aside>
			</div>
</BaseLayout>
