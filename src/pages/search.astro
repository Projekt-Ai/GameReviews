---
import BaseLayout from '../layouts/BaseLayout.astro';
import { SITE_TITLE } from '../consts';
import { getVisibleBossFeatures } from '../utils/boss-features';
import { contentVisibilityOptions } from '../utils/content';
import { getVisibleReviews } from '../utils/reviews';
import searchStylesHref from '../styles/pages/search.css?url';

const visibility = contentVisibilityOptions(import.meta.env.DEV);
const reviews = await getVisibleReviews(visibility);

const bossFeatures = await getVisibleBossFeatures(visibility);

const searchIndex = [
	...reviews.map((post) => ({
		title: post.data.title,
		description: post.data.description,
		blurb: post.data.blurb ?? '',
		url: `/reviews/${post.id}/`,
		type: 'Review',
		date: post.data.pubDate.toISOString(),
	})),
	...bossFeatures.map((post) => ({
		title: post.data.title,
		description: post.data.description,
		blurb: post.data.blurb ?? '',
		url: `/bossfeatures/${post.id}/`,
		type: 'Boss Feature',
		date: post.data.pubDate.toISOString(),
	})),
].sort((a, b) => new Date(b.date).valueOf() - new Date(a.date).valueOf());
---

<BaseLayout
	title={`Search | ${SITE_TITLE}`}
	description="Search all content"
	variantFonts={true}
	stylesheets={[searchStylesHref]}
	mainClass="search-page"
>
			<section class="search-head">
				<p class="search-eyebrow">{SITE_TITLE} / Search</p>
				<h1 class="search-title">Search</h1>
			</section>

			<div class="search-bar">
				<svg class="search-bar-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
					<circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"></circle>
					<path d="M20 20L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
				</svg>
				<input
					type="text"
					class="search-bar-input"
					placeholder="Search by title or description..."
					data-search-input
					autofocus
				/>
			</div>

			<div class="search-meta" data-search-meta></div>
			<div class="search-results" data-search-results></div>
</BaseLayout>

<script is:inline define:vars={{ searchIndex }}>
	(() => {
		const input = document.querySelector('[data-search-input]');
		const meta = document.querySelector('[data-search-meta]');
		const results = document.querySelector('[data-search-results]');
		if (!input || !meta || !results) return;

		const index = searchIndex;

		const formatDate = (iso) => {
			const d = new Date(iso);
			return d.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
		};

		const escapeHtml = (str) =>
			str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');

		const render = (query) => {
			const q = query.trim().toLowerCase();

			if (!q) {
				meta.textContent = '';
				results.innerHTML =
					'<div class="search-prompt"><p class="search-prompt-text">Type to search across all content.</p></div>';
				return;
			}

			const matched = index.filter(
				(entry) =>
					entry.title.toLowerCase().includes(q) ||
					entry.description.toLowerCase().includes(q) ||
					entry.blurb.toLowerCase().includes(q),
			);

			meta.textContent = matched.length
				? `${matched.length} result${matched.length === 1 ? '' : 's'} for "${query.trim()}"`
				: '';

			if (!matched.length) {
				results.innerHTML = `
					<div class="search-empty">
						<p class="search-empty-heading">No results found</p>
						<p class="search-empty-text">Try a different search term or browse the <a href="/reviews" style="color:#d4af37;">reviews archive</a>.</p>
					</div>`;
				return;
			}

			results.innerHTML = matched
				.map(
					(entry) => `
				<a href="${escapeHtml(entry.url)}" class="search-result">
					<div>
						<div class="result-type">${escapeHtml(entry.type)}</div>
						<h2 class="result-title">${escapeHtml(entry.title)}</h2>
						<p class="result-desc">${escapeHtml(entry.blurb || entry.description)}</p>
					</div>
					<span class="result-date">${formatDate(entry.date)}</span>
				</a>`,
				)
				.join('');
		};

		// Read initial query from URL
		const params = new URLSearchParams(window.location.search);
		const initialQuery = params.get('q') || '';
		input.value = initialQuery;
		render(initialQuery);

		// Live filtering as user types
		input.addEventListener('input', () => {
			render(input.value);
			const url = new URL(window.location);
			if (input.value.trim()) {
				url.searchParams.set('q', input.value.trim());
			} else {
				url.searchParams.delete('q');
			}
			history.replaceState(null, '', url);
		});
	})();
</script>
